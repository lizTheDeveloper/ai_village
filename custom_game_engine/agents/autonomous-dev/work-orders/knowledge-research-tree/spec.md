# Work Order: Knowledge-Based Research Tree System

**Phase:** Phase 13 Enhancement
**Created:** 2026-01-02
**Spec Agent:** human
**Status:** READY

---

## ðŸ’¬ User Notes

> **This section contains context from the user about implementation difficulty, gotchas, or tips. Check this section FIRST before starting work!**

### Difficulty Assessment
- **Overall Complexity:** Hard
- **Hardest Part:** Prerequisite chain validation and technology unlock detection
- **Easier Than It Looks:** Component structure is straightforward, complexity is in the system logic

### User Tips
- ðŸ’¡ **Age System Already Exists** - Use `AgeCategory` type from `AgentComponent.ts:104` ('child' | 'teen' | 'adult' | 'elder')
- ðŸ’¡ **Skill System Integrated** - `SkillsComponent` already handles skill tracking and experience
- ðŸ’¡ **Library Buildings Exist** - Can reuse existing library building type
- ðŸ’¡ **Reading Should Grant Skills** - When reading completes, add experience to agent's skills based on paper's `skillGrants` field
- ðŸŽ¯ **No Debug Logs** - Do NOT add console.log statements, use dashboard metrics instead
- ðŸŽ¯ **No Silent Fallbacks** - Throw errors for missing prerequisites, invalid ages, etc.

### Common Pitfalls
- âŒ **Using Math.min/max for Clamping** - Use proper validation instead, throw errors for out-of-range
- âŒ **Silent Defaults with .get()** - Require critical fields explicitly, crash if missing
- âŒ **Query Inside Loops** - Cache `world.query()` results before loops
- âœ… **Component Types Lowercase** - Use 'research_paper', 'agent_knowledge', 'reading_progress'
- âœ… **Validate Early** - Check age/skill requirements before starting to read

### Questions to Ask User
- Should paper content be generated by LLM or use templates?
- Should papers be physical entities that can be stolen/destroyed?
- How should we handle save/load with new components?

---

## Spec Reference

- **Primary Spec:** `openspec/specs/research-system/knowledge-based-research.md`
- **Supporting Specs:**
  - `openspec/specs/research-system/spec.md` - Original research system
  - `custom_game_engine/architecture/KNOWLEDGE_RESEARCH_TREE_SPEC.md` - Architecture overview
- **Related Specs:**
  - Skills System - For skill grant integration
  - Age/Lifecycle - For age-based restrictions

---

## Requirements Summary

The system SHALL:

1. **Paper Reading** - Agents read papers to gain knowledge and skills (age >= teen only)
2. **Skill Grants** - Reading papers grants skill experience in related fields
3. **Prerequisite Chains** - Agents must read prerequisites before authoring new papers
4. **Age Restrictions** - Children cannot read; teens/adults/elders have tier limits
5. **Technology Unlocks** - Technologies unlock when ALL tagged papers are published
6. **Library Integration** - Research requires access to library building

---

## Acceptance Criteria

### Criterion 1: Paper Reading with Age Validation
- **WHEN:** Teen/adult/elder agent starts reading a paper they qualify for
- **THEN:** System creates `ReadingProgressComponent` and increments progress each tick
- **WHEN:** Child agent attempts to read
- **THEN:** System throws error with clear message
- **Verification:** Manual test with agents of different ages

### Criterion 2: Skill Grant System
- **WHEN:** Agent completes reading a paper
- **THEN:** System grants skill experience from paper's `skillGrants` field
- **THEN:** Agent's `SkillsComponent` is updated
- **Verification:** Check agent skills before/after reading, verify experience gained

### Criterion 3: Prerequisite Enforcement
- **WHEN:** Agent has not read all prerequisite papers
- **THEN:** Paper does NOT appear in `potentialContributions`
- **WHEN:** Agent completes all prerequisites
- **THEN:** Paper appears in `potentialContributions` list
- **Verification:** Track agent knowledge through prerequisite chain

### Criterion 4: Technology Unlock Detection
- **WHEN:** Final paper in a technology set is published
- **THEN:** System detects completion and unlocks technology
- **THEN:** Technology benefits (recipes, buildings, abilities) are granted
- **THEN:** Event "technology:unlocked" is emitted
- **Verification:** Monitor technology state through paper publication sequence

### Criterion 5: Age-Based Tier Restrictions
- **WHEN:** Teen tries to read Tier 3+ paper
- **THEN:** System blocks with clear error message
- **WHEN:** Adult tries to read Tier 5 paper
- **THEN:** System blocks with clear error message
- **WHEN:** Elder tries to read any tier
- **THEN:** System allows (no tier restrictions)
- **Verification:** Test boundary cases for each age category

---

## System Integration

### Existing Systems Affected
| System | File | Integration Type |
|--------|------|-----------------|
| Research System | `packages/core/src/research/ResearchSystem.ts` | Extended |
| Skill System | `packages/core/src/components/SkillsComponent.ts` | Modified |
| Agent Behavior | `packages/core/src/behaviors/research.ts` | Modified |
| Technology Progress | `packages/core/src/research/TechnologyProgressSystem.ts` | Modified |
| Library Building | `packages/core/src/buildings/library.ts` | Extended |

### New Components Needed
- `ResearchPaperComponent` - Paper metadata, prerequisites, skills
- `AgentKnowledgeComponent` - Track papers read/authored by agent
- `ReadingProgressComponent` - Active reading session state

### New Systems Needed
- `ResearchLibrarySystem` - Global paper collection management
- `ReadingSystem` - Handle reading progress and skill grants
- `AuthoringSystem` - Handle paper creation by agents

### Events
- **Emits:**
  - `paper:published` - When new paper added to library
  - `paper:read_complete` - When agent finishes reading
  - `technology:unlocked` - When all papers in set complete
  - `skill:gained` - When reading grants skill experience
- **Listens:**
  - `research:started` - Agent begins research behavior
  - `agent:age_changed` - Update readable papers when age changes

---

## Implementation Phases

### Phase 1: Component Architecture - 2-3 hours
**Files:**
- `packages/core/src/components/ResearchPaperComponent.ts`
- `packages/core/src/components/AgentKnowledgeComponent.ts`
- `packages/core/src/components/ReadingProgressComponent.ts`
- `packages/core/src/components/index.ts`

1. Create `ResearchPaperComponent` with all fields
   - Paper identity (id, title, field, tier)
   - Prerequisites (paper IDs)
   - Reading requirements (age, skills)
   - Skill grants (skill: amount mapping)
   - Technology tags
   - Publication metadata
   - Tracking (readBy set)

2. Create `AgentKnowledgeComponent`
   - readPapers: Set<string>
   - authoredPapers: Set<string>
   - currentReading?: string
   - potentialContributions: string[]

3. Create `ReadingProgressComponent`
   - paperId, readerId, startTick
   - progressPercent, comprehension

4. Export all components from index.ts
5. Register component types in ComponentRegistry

### Phase 2: Reading System - 2-3 hours
**Files:**
- `packages/core/src/systems/ReadingSystem.ts`
- `packages/core/src/systems/index.ts`
- `packages/core/src/systems/registerAllSystems.ts`

1. Implement `ReadingSystem.update()`
   - Query for all ReadingProgressComponent entities
   - For each reading session:
     - Calculate progress increment (skill-based, tier-based)
     - Update progressPercent
     - Check for completion
   - On completion:
     - Grant skill experience to agent
     - Add paper to readPapers set
     - Remove ReadingProgressComponent
     - Update potentialContributions
     - Emit events

2. Implement age validation helper
   ```typescript
   canAgentRead(agent: Entity, paper: ResearchPaperComponent): boolean
   ```

3. Implement skill validation helper
   ```typescript
   meetsSkillRequirements(agent: Entity, paper: ResearchPaperComponent): boolean
   ```

4. Implement reading speed calculation
   ```typescript
   calculateReadingProgress(agent, paper, deltaTime): number
   ```

5. Register system with priority

### Phase 3: Library System - 2-3 hours
**Files:**
- `packages/core/src/systems/ResearchLibrarySystem.ts`
- `packages/core/src/research/types.ts`

1. Implement `ResearchLibrarySystem`
   - Maintain global Set of published papers
   - `getReadablePapers(agent)` - filter by age, skills, already read
   - `getAuthorablePapers(agent)` - check prerequisite completion
   - `isTechnologyUnlocked(techId)` - check all tagged papers published
   - `publishPaper(paper)` - add to library, check unlocks

2. Create technology-to-papers mapping data structure
   ```typescript
   interface TechnologyDefinition {
     id: string;
     name: string;
     requiredPapers: string[];
     unlocks: TechnologyUnlock[];
   }
   ```

3. Implement prerequisite chain validation
   - Detect circular dependencies
   - Validate all prerequisites exist
   - Ensure reachable path from Tier 1

### Phase 4: Authoring System - 2-3 hours
**Files:**
- `packages/core/src/systems/AuthoringSystem.ts`
- `packages/core/src/behaviors/research.ts`

1. Implement `AuthoringSystem.update()`
   - Detect when agents can contribute
   - Update potentialContributions lists
   - Handle authoring progress
   - Publish completed papers

2. Integrate with LLM for paper selection
   - Provide potentialContributions list
   - Let LLM choose which to research
   - Generate paper content (optional)

3. Update research behavior
   - Add library navigation
   - Add paper browsing
   - Add reading action
   - Add authoring action

### Phase 5: Technology Progress System - 2 hours
**Files:**
- `packages/core/src/systems/TechnologyProgressSystem.ts`

1. Modify unlock detection to use papers instead of progress
2. Monitor paper publications
3. Check technology completion on each publish
4. Grant technology benefits when unlocked
5. Emit unlock events

### Phase 6: Content Creation - 3-4 hours
**Files:**
- `packages/core/src/research/paperTrees.ts`
- `packages/core/src/research/defaultPapers.ts`

1. Map existing technologies to paper trees
2. Define prerequisite chains for each field:
   - Agriculture (Tier 1 â†’ 5)
   - Metallurgy (Tier 1 â†’ 5)
   - Alchemy (Tier 1 â†’ 5)
   - Construction (Tier 1 â†’ 5)
   - etc.

3. Create paper metadata for each:
   - Unique ID
   - Descriptive title
   - Field assignment
   - Tier level
   - Skill grants
   - Age/skill requirements
   - Technology tags

4. Validate tree structure (no orphans, circular deps)

### Phase 7: Testing & Balancing - 2-3 hours

1. **Unit Tests:**
   - Component serialization
   - Age validation logic
   - Skill requirement checking
   - Prerequisite chain resolution

2. **Integration Tests:**
   - Reading â†’ skill gain
   - Prerequisite â†’ authoring unlock
   - All papers â†’ technology unlock
   - Age changes â†’ readable papers update

3. **Manual Verification:**
   - Create agents of different ages
   - Have teens read Tier 1 papers
   - Verify skill grants apply
   - Verify prerequisite chains work
   - Verify technology unlocks fire

4. **Balance Testing:**
   - Adjust reading times (100 ticks for Tier 1)
   - Verify skill scaling feels good
   - Check technology unlock pacing

**Total Estimated Time:** 16-21 hours

---

## Notes for Implementation Agent

### Key Design Principles

1. **No Silent Fallbacks:** Throw errors for invalid states (child reading, missing prerequisites, etc.)
2. **No Clamping:** Use validation, not Math.min/max
3. **Cache Queries:** Never call `world.query()` inside loops
4. **Lowercase Component Types:** 'research_paper', not 'ResearchPaper'
5. **No Console Logs:** Use dashboard metrics or error throws only

### Integration Gotchas

1. **AgeCategory Type:** Defined in `AgentComponent.ts:104` as `'child' | 'teen' | 'adult' | 'elder'`
2. **SkillsComponent Integration:** Use existing `addSkillExperience(skillId, amount)` method
3. **Component Registration:** Must register in `ComponentRegistry` and export from `index.ts`
4. **System Priority:** ReadingSystem should run before AuthoringSystem
5. **Event Emission:** Use `world.emit(eventName, eventData)` for technology unlocks

### Testing Strategy

1. **Unit Tests:** Age validation, skill checking, prerequisite resolution
2. **Integration Tests:** Full reading â†’ authoring â†’ unlock flow
3. **Manual Verification:**
   - curl dashboard to check research metrics
   - Create test agents with different ages
   - Monitor paper publication events
   - Verify technology unlock grants

---

## Dependencies

**Upstream (must be complete before starting):**
- Phase 13: Research & Discovery âœ… (provides foundation)
- Skill System âœ… (already exists)
- Age/Lifecycle System âœ… (ageCategory in AgentComponent)
- Library Building âœ… (already exists)

**Downstream (blockers for other work):**
- None - this is self-contained enhancement

---

## Success Definition

This work order is **COMPLETE** when:

1. âœ… All three components created and registered
2. âœ… ReadingSystem grants skills on completion
3. âœ… LibrarySystem filters papers by age and skills
4. âœ… AuthoringSystem only allows papers with completed prerequisites
5. âœ… TechnologyProgressSystem unlocks when all papers published
6. âœ… Children cannot read research papers (throws error)
7. âœ… Teens/adults/elders have correct tier restrictions
8. âœ… Dashboard shows paper publication and reading metrics
9. âœ… Build passes: `npm run build` completes without errors
10. âœ… Tests pass: All new and existing tests pass
11. âœ… No console.log statements in code
12. âœ… Manual verification: Can read paper â†’ gain skill â†’ author new paper â†’ unlock technology

---

## Risks & Mitigations

| Risk | Likelihood | Impact | Mitigation |
|------|-----------|--------|------------|
| Technology unlocks too slow | Medium | High | Balance reading times, allow parallel researchers |
| Prerequisite chains too complex | Medium | Medium | Start with simple chains, add complexity gradually |
| LLM cost for paper content | Low | Medium | Cache generated content, use templates first |
| Performance with many papers | Low | Medium | Index papers by field/tier, cache queries |
| Knowledge loss feels punishing | Low | Medium | Add rediscovery bonus, make papers persist |
| Circular dependencies in prerequisites | Low | High | Validation during content creation phase |

---

**End of Work Order**
