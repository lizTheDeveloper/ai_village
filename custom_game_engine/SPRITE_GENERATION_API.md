# Sprite Generation API Documentation

Complete API reference for the PixelLab sprite generation system.

## Overview

The sprite generation system consists of three components:

1. **Metrics Server** (port 8766) - Manages the generation queue and tracks jobs
2. **PixelLab Daemon** - Processes the queue and generates sprites/animations via PixelLab API
3. **Orchestration Dashboard** (port 3030) - Displays queue status and daemon activity

## Architecture

```
Game/Renderer → Metrics Server → Queue File → PixelLab Daemon → PixelLab API
                       ↓               ↓              ↓
                   In-Memory      sprite-        pixellab-
                    Queue      generation-     daemon-state
                              queue.json         .json
```

---

## Metrics Server APIs (port 8766)

Base URL: `http://localhost:8766`

### Queue a Sprite Generation

```http
POST /api/sprites/generate
Content-Type: application/json

{
  "folderId": "cat_orange",
  "description": "Orange tabby cat, sitting pose, top-down view",
  "traits": {
    "category": "animals.pets",
    "size": 32
  }
}
```

**Response:**
```json
{
  "status": "queued",
  "folderId": "cat_orange",
  "message": "Sprite generation queued. Check sprite-generation-queue.json and process with PixelLab MCP tools."
}
```

**Notes:**
- If sprite already exists on disk, returns early without queueing
- If already queued/generating, skips duplicate
- Saves to `sprite-generation-queue.json` for daemon processing
- Tracks job in-memory with status: `queued` → `generating` → `complete`/`failed`

---

### Queue an Animation Generation

```http
POST /api/animations/generate
Content-Type: application/json

{
  "folderId": "cat_orange",
  "animationName": "walking",
  "actionDescription": "cat walking slowly, tail up"
}
```

**Response:**
```json
{
  "status": "queued",
  "folderId": "cat_orange",
  "animationName": "walking",
  "message": "Animation generation queued"
}
```

**Notes:**
- Requires base sprite to already exist (needs reference image)
- Generates 5 directions: south, south-east, east, north-east, north
- Other directions (south-west, west, north-west) are mirrored automatically
- Uses PixelLab `/animate-with-text` API with reference sprite image

---

### Get Generation Queue Status

```http
GET /api/generation/queue
```

**Response:**
```json
{
  "summary": {
    "sprites": {
      "pending": 2,
      "completed": 15,
      "total": 17
    },
    "animations": {
      "pending": 1,
      "completed": 8,
      "total": 9
    }
  },
  "pending": {
    "sprites": [
      {
        "folderId": "cat_orange",
        "status": "queued",
        "description": "Orange tabby cat...",
        "queuedAt": 1767575036645
      }
    ],
    "animations": [
      {
        "folderId": "cat_orange",
        "animationName": "walking",
        "status": "generating",
        "actionDescription": "cat walking slowly",
        "queuedAt": 1767575036650
      }
    ]
  },
  "completed": {
    "sprites": [ /* last 10 completed */ ],
    "animations": [ /* last 10 completed */ ]
  }
}
```

**Job Statuses:**
- `queued` - Waiting to be processed
- `generating` - Currently being generated by daemon
- `complete` - Successfully generated
- `failed` - Generation failed (check logs)

---

### Mark Sprite/Animation Complete

```http
POST /api/sprites/complete
Content-Type: application/json

{
  "folderId": "cat_orange"
}
```

```http
POST /api/animations/complete
Content-Type: application/json

{
  "folderId": "cat_orange",
  "animationName": "walking"
}
```

**Response:**
```json
{
  "status": "complete",
  "message": "Marked as complete"
}
```

**Used by:** PixelLab daemon after successful generation

---

## Dashboard APIs (port 3030)

Base URL: `http://localhost:3030`

### Get Generation Queue (Proxy)

```http
GET /api/generation/queue
```

Proxies to metrics server (`http://localhost:8766/api/generation/queue`).

**Fallback:** If metrics server is down, reads from `sprite-generation-queue.json` directly.

---

### Get PixelLab Daemon Status

```http
GET /api/pixellab/status
```

**Response:**
```json
{
  "running": true,
  "totalGenerated": 57,
  "totalDownloaded": 57,
  "startedAt": "2026-01-04T22:12:08.010Z",
  "lastCheck": "2026-01-04T22:13:06.189Z",
  "currentJob": {
    "type": "sprite",
    "folderId": "cat_orange",
    "direction": "south",
    "progress": 45
  },
  "queuePosition": 1,
  "totalInQueue": 5
}
```

**When daemon is idle:**
```json
{
  "running": true,
  "totalGenerated": 57,
  "totalDownloaded": 57,
  "currentJob": null,
  "queuePosition": null,
  "totalInQueue": null
}
```

**When daemon is not running:**
```json
{
  "running": false,
  "error": "Daemon state file not found"
}
```

**Source:** Reads from `scripts/pixellab-daemon-state.json`

---

## File System

### sprite-generation-queue.json

Location: `custom_game_engine/sprite-generation-queue.json`

**Purpose:** Queue file shared between metrics server (writer) and daemon (reader)

**Format:**
```json
{
  "sprites": [
    {
      "folderId": "cat_orange",
      "characterId": "",
      "status": "queued",
      "queuedAt": 1767575036645,
      "description": "Orange tabby cat",
      "traits": {
        "category": "animals.pets"
      }
    }
  ],
  "animations": [
    {
      "folderId": "cat_orange",
      "animationName": "walking",
      "characterId": "",
      "status": "queued",
      "queuedAt": 1767575036650,
      "actionDescription": "cat walking slowly"
    }
  ]
}
```

**Updated by:** Metrics server after queueing/completing jobs
**Read by:** PixelLab daemon to process jobs

---

### pixellab-daemon-state.json

Location: `custom_game_engine/scripts/pixellab-daemon-state.json`

**Purpose:** Daemon status tracking (what it's currently doing)

**Format:**
```json
{
  "totalGenerated": 57,
  "totalDownloaded": 57,
  "startedAt": "2026-01-04T22:12:08.010Z",
  "lastCheck": "2026-01-04T22:13:06.189Z",
  "currentJob": {
    "type": "sprite",
    "folderId": "cat_orange",
    "direction": "south",
    "progress": 45
  },
  "queuePosition": 1,
  "totalInQueue": 5
}
```

**Updated by:** PixelLab daemon during processing
**Read by:** Dashboard via `/api/pixellab/status`

---

## Integration Guide

### From Game/Renderer

When a sprite is requested but doesn't exist:

```typescript
import { lookupSprite } from './sprites/SpriteService.js';

const spriteResult = lookupSprite(traits);

if (!spriteResult.found) {
  // Automatically queued via SpriteService
  console.log('Sprite queued for generation:', spriteResult.folderId);
}
```

The `SpriteService.lookupSprite()` function automatically calls the metrics server to queue generation.

---

### From PixelLab Daemon

The daemon polls `sprite-generation-queue.json` every 5 seconds:

1. Read queue file
2. Pick next job with status `queued`
3. Update status to `generating`
4. Call PixelLab API
5. Save generated sprite to disk
6. Mark as `complete` via `/api/sprites/complete`
7. Update daemon state file
8. Repeat

**Daemon Commands:**
```bash
# Start daemon
npm run pixellab-daemon

# Check status
curl http://localhost:3030/api/pixellab/status

# Check queue
curl http://localhost:8766/api/generation/queue
```

---

### From Dashboard

The dashboard displays real-time status:

- **Queue metrics** - Pending/completed counts
- **Daemon status** - Current job, progress, queue position
- **Live items** - List of pending sprites/animations

**Auto-refresh:** Every 5 seconds

**UI Location:** Dashboard → PixelLab Generation panel (top of left column)

---

## Direction Mirroring

Animations are only generated for 5 directions to save API calls:

**Generated:**
- south
- south-east
- east
- north-east
- north

**Mirrored:**
- south-west (mirror of south-east)
- west (mirror of east)
- north-west (mirror of north-east)

The `PixelLabSpriteLoader` handles mirroring automatically when loading sprites.

---

## Error Handling

### Sprite Already Exists

```json
{
  "status": "exists",
  "folderId": "cat_orange",
  "message": "Sprite already exists on disk"
}
```

### Already Queued

```json
{
  "status": "already_queued",
  "folderId": "cat_orange",
  "message": "Already queued or generating"
}
```

### Queue File Errors

If the queue file is corrupted or unreadable, the daemon logs an error and continues polling. The metrics server recreates the file on next queue operation.

---

## Monitoring

### Check if everything is running

```bash
# Metrics server
curl http://localhost:8766/api/generation/queue

# Dashboard
curl http://localhost:3030/api/pixellab/status

# Daemon process
ps aux | grep pixellab-daemon
```

### View logs

```bash
# Metrics server
tail -f custom_game_engine/metrics-server.log

# PixelLab daemon
tail -f custom_game_engine/pixellab-daemon.log

# Dashboard
tail -f /tmp/dashboard.log
```

---

## Troubleshooting

### Queue not updating

1. Check metrics server is running: `lsof -nP -iTCP:8766`
2. Check queue file exists: `ls sprite-generation-queue.json`
3. Check API: `curl http://localhost:8766/api/generation/queue`

### Daemon not processing

1. Check daemon is running: `ps aux | grep pixellab-daemon`
2. Check daemon state: `cat scripts/pixellab-daemon-state.json`
3. Check daemon logs: `tail -f pixellab-daemon.log`
4. Check API key: Daemon needs PIXELLAB_API_KEY environment variable

### Dashboard not showing queue

1. Refresh browser (Cmd+Shift+R for hard refresh)
2. Check browser console for errors
3. Verify dashboard server is running: `lsof -nP -iTCP:3030`
4. Test API: `curl http://localhost:3030/api/generation/queue`

---

## Development

### Adding new generation types

1. Add new interface in `scripts/metrics-server.ts` (e.g., `TileGenerationJob`)
2. Create Map to track jobs: `const tileGenerationJobs = new Map()`
3. Add API endpoint: `POST /api/tiles/generate`
4. Update `saveGenerationQueue()` to include new job type
5. Update daemon to process new job type
6. Update dashboard to display new job type

### Rate Limiting

The daemon respects PixelLab API rate limits:
- **5 second delay** between generation requests
- Configured in `pixellab-daemon.ts` constant: `RATE_LIMIT_DELAY_MS`

---

## Summary

**To queue a sprite:**
```bash
curl -X POST http://localhost:8766/api/sprites/generate \
  -H "Content-Type: application/json" \
  -d '{"folderId":"test","description":"blue wizard","traits":{}}'
```

**To check the queue:**
```bash
curl http://localhost:8766/api/generation/queue | jq
```

**To check daemon status:**
```bash
curl http://localhost:3030/api/pixellab/status | jq
```

**Dashboard:** http://localhost:3030
