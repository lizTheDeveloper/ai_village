import { describe, it, expect, beforeEach, vi } from 'vitest';
import { PlantSystem } from '../PlantSystem';
import { PlantComponent } from '../../components/PlantComponent';
import { World } from '../../ecs/World';
import { EventBus } from '../../events/EventBus';
import type { PlantSpecies, StageTransition } from '../../types/PlantSpecies';

describe('PlantSystem', () => {
  let world: World;
  let system: PlantSystem;
  let eventBus: EventBus;

  beforeEach(() => {
    world = new World();
    eventBus = new EventBus();
    system = new PlantSystem(eventBus);
    world.registerSystem(system);
  });

  describe('Acceptance Criterion 2: Stage Transitions', () => {
    it('should advance to next stage when conditions are met', () => {
      const entity = world.createEntity();
      const plant = new PlantComponent({
        speciesId: 'wheat',
        position: { x: 10, y: 20 },
        stage: 'seed'
      });
      entity.addComponent(PlantComponent, plant);

      // Mock ideal conditions
      plant.hydration = 100;
      plant.nutrition = 100;
      plant.health = 100;
      plant.stageProgress = 1.0; // Ready to transition

      // Mock environment
      vi.spyOn(system as any, 'getEnvironment').mockReturnValue({
        temperature: 20,
        moisture: 80,
        nutrients: 100,
        season: 'spring',
        lightLevel: 100
      });

      system.update(world, 1);

      expect(plant.stage).toBe('germinating');
      expect(plant.stageProgress).toBe(0);
    });

    it('should emit stage change event on transition', () => {
      const entity = world.createEntity();
      const plant = new PlantComponent({
        speciesId: 'wheat',
        position: { x: 10, y: 20 },
        stage: 'seed'
      });
      entity.addComponent(PlantComponent, plant);

      plant.stageProgress = 1.0;

      const handler = vi.fn();
      eventBus.on('plant:stageChanged', handler);

      system.update(world, 1);

      expect(handler).toHaveBeenCalledWith({
        entityId: entity.id,
        previousStage: 'seed',
        newStage: 'germinating',
        position: { x: 10, y: 20 }
      });
    });

    it('should stay in current stage when conditions NOT met', () => {
      const entity = world.createEntity();
      const plant = new PlantComponent({
        speciesId: 'wheat',
        position: { x: 10, y: 20 },
        stage: 'seed'
      });
      entity.addComponent(PlantComponent, plant);

      plant.stageProgress = 1.0;
      plant.hydration = 0; // No water - can't germinate

      system.update(world, 1);

      expect(plant.stage).toBe('seed');
    });

    it('should execute transition effects on stage change', () => {
      const entity = world.createEntity();
      const plant = new PlantComponent({
        speciesId: 'wheat',
        position: { x: 10, y: 20 },
        stage: 'vegetative'
      });
      entity.addComponent(PlantComponent, plant);

      plant.stageProgress = 1.0;

      system.update(world, 1);

      // vegetative -> flowering should spawn flowers
      expect(plant.stage).toBe('flowering');
      expect(plant.flowerCount).toBeGreaterThan(0);
    });

    it('should progress through all 11 stages in order', () => {
      const expectedOrder = [
        'seed',
        'germinating',
        'sprout',
        'vegetative',
        'flowering',
        'fruiting',
        'mature',
        'seeding',
        'senescence',
        'decay',
        'dead'
      ];

      const entity = world.createEntity();
      const plant = new PlantComponent({
        speciesId: 'wheat',
        position: { x: 10, y: 20 }
      });
      entity.addComponent(PlantComponent, plant);

      // Mock ideal conditions
      vi.spyOn(system as any, 'getEnvironment').mockReturnValue({
        temperature: 20,
        moisture: 80,
        nutrients: 100,
        season: 'spring',
        lightLevel: 100
      });

      for (let i = 0; i < expectedOrder.length - 1; i++) {
        expect(plant.stage).toBe(expectedOrder[i]);
        plant.stageProgress = 1.0;
        system.update(world, 1);
      }

      expect(plant.stage).toBe('dead');
    });
  });

  describe('Acceptance Criterion 3: Environmental Conditions', () => {
    it('should check temperature from TemperatureSystem', () => {
      const entity = world.createEntity();
      const plant = new PlantComponent({
        speciesId: 'wheat',
        position: { x: 10, y: 20 }
      });
      entity.addComponent(PlantComponent, plant);

      const getTemperatureSpy = vi.spyOn(system as any, 'getTemperature');

      system.update(world, 1);

      expect(getTemperatureSpy).toHaveBeenCalledWith({ x: 10, y: 20 }, world);
    });

    it('should check moisture from SoilSystem', () => {
      const entity = world.createEntity();
      const plant = new PlantComponent({
        speciesId: 'wheat',
        position: { x: 10, y: 20 }
      });
      entity.addComponent(PlantComponent, plant);

      const getMoistureSpy = vi.spyOn(system as any, 'getMoisture');

      system.update(world, 1);

      expect(getMoistureSpy).toHaveBeenCalledWith({ x: 10, y: 20 }, world);
    });

    it('should reduce health when temperature is too low', () => {
      const entity = world.createEntity();
      const plant = new PlantComponent({
        speciesId: 'wheat',
        position: { x: 10, y: 20 },
        stage: 'sprout'
      });
      entity.addComponent(PlantComponent, plant);

      const initialHealth = plant.health;

      // Mock cold temperature
      vi.spyOn(system as any, 'getEnvironment').mockReturnValue({
        temperature: -5, // Too cold for wheat
        moisture: 80,
        nutrients: 100,
        season: 'winter',
        lightLevel: 100
      });

      system.update(world, 1);

      expect(plant.health).toBeLessThan(initialHealth);
    });

    it('should reduce health when moisture is too low', () => {
      const entity = world.createEntity();
      const plant = new PlantComponent({
        speciesId: 'wheat',
        position: { x: 10, y: 20 },
        stage: 'vegetative'
      });
      entity.addComponent(PlantComponent, plant);

      plant.hydration = 10; // Very low

      const initialHealth = plant.health;

      system.update(world, 1);

      expect(plant.health).toBeLessThan(initialHealth);
    });

    it('should slow growth when conditions are suboptimal', () => {
      const entity = world.createEntity();
      const plant = new PlantComponent({
        speciesId: 'wheat',
        position: { x: 10, y: 20 },
        stage: 'vegetative'
      });
      entity.addComponent(PlantComponent, plant);

      // Suboptimal conditions
      vi.spyOn(system as any, 'getEnvironment').mockReturnValue({
        temperature: 15, // Cooler than optimal
        moisture: 40, // Drier than optimal
        nutrients: 50,
        season: 'spring',
        lightLevel: 60
      });

      const initialProgress = plant.stageProgress;

      system.update(world, 1);

      const progressGained = plant.stageProgress - initialProgress;

      // Now test with optimal conditions
      vi.spyOn(system as any, 'getEnvironment').mockReturnValue({
        temperature: 22,
        moisture: 80,
        nutrients: 100,
        season: 'spring',
        lightLevel: 100
      });

      plant.stageProgress = 0;
      system.update(world, 1);

      const optimalProgressGained = plant.stageProgress;

      expect(progressGained).toBeLessThan(optimalProgressGained);
    });

    it('should stop growth when health reaches 0', () => {
      const entity = world.createEntity();
      const plant = new PlantComponent({
        speciesId: 'wheat',
        position: { x: 10, y: 20 },
        stage: 'vegetative'
      });
      entity.addComponent(PlantComponent, plant);

      plant.health = 0;

      const initialProgress = plant.stageProgress;

      system.update(world, 1);

      expect(plant.stageProgress).toBe(initialProgress);
      expect(plant.stage).toBe('dead');
    });
  });

  describe('Acceptance Criterion 4: Seed Production and Dispersal', () => {
    it('should produce seeds when plant reaches seeding stage', () => {
      const entity = world.createEntity();
      const plant = new PlantComponent({
        speciesId: 'wheat',
        position: { x: 10, y: 20 },
        stage: 'mature'
      });
      entity.addComponent(PlantComponent, plant);

      plant.stageProgress = 1.0;

      system.update(world, 1);

      expect(plant.stage).toBe('seeding');
      expect(plant.seedsProduced).toBeGreaterThan(0);
    });

    it('should drop seeds in radius around parent plant', () => {
      const entity = world.createEntity();
      const plant = new PlantComponent({
        speciesId: 'wheat',
        position: { x: 10, y: 20 },
        stage: 'seeding'
      });
      entity.addComponent(PlantComponent, plant);

      plant.seedsProduced = 10;

      system.update(world, 1);

      expect(plant.seedsDropped.length).toBeGreaterThan(0);

      // Check seeds are within dispersal radius
      plant.seedsDropped.forEach(seedPos => {
        const distance = Math.sqrt(
          Math.pow(seedPos.x - plant.position.x, 2) +
          Math.pow(seedPos.y - plant.position.y, 2)
        );
        expect(distance).toBeLessThanOrEqual(5); // Assuming max radius of 5
      });
    });

    it('should create Seed entities with inherited genetics', () => {
      const entity = world.createEntity();
      const plant = new PlantComponent({
        speciesId: 'wheat',
        position: { x: 10, y: 20 },
        stage: 'seeding',
        genetics: {
          growthRate: 1.5,
          yieldAmount: 1.2,
          diseaseResistance: 80,
          droughtTolerance: 60,
          coldTolerance: 40,
          flavorProfile: 70,
          mutations: []
        }
      });
      entity.addComponent(PlantComponent, plant);

      plant.seedsProduced = 5;

      const seedEntities: any[] = [];
      vi.spyOn(world, 'createEntity').mockImplementation(() => {
        const seedEntity = { id: Math.random().toString(), components: new Map() };
        seedEntities.push(seedEntity);
        return seedEntity as any;
      });

      system.update(world, 1);

      expect(seedEntities.length).toBeGreaterThan(0);

      // Seeds should have genetics similar to parent
      seedEntities.forEach(seed => {
        const seedGenetics = seed.genetics;
        expect(seedGenetics.growthRate).toBeCloseTo(1.5, 0.3); // Allow mutation variance
      });
    });

    it('should emit seed:dispersed event when seeds drop', () => {
      const entity = world.createEntity();
      const plant = new PlantComponent({
        speciesId: 'wheat',
        position: { x: 10, y: 20 },
        stage: 'seeding'
      });
      entity.addComponent(PlantComponent, plant);

      plant.seedsProduced = 5;

      const handler = vi.fn();
      eventBus.on('seed:dispersed', handler);

      system.update(world, 1);

      expect(handler).toHaveBeenCalled();
    });

    it('should check tile suitability before placing seed', () => {
      const entity = world.createEntity();
      const plant = new PlantComponent({
        speciesId: 'wheat',
        position: { x: 10, y: 20 },
        stage: 'seeding'
      });
      entity.addComponent(PlantComponent, plant);

      plant.seedsProduced = 10;

      // Mock some tiles as occupied
      vi.spyOn(system as any, 'isTileSuitable').mockImplementation((pos: any) => {
        return pos.x % 2 === 0; // Only even tiles suitable
      });

      system.update(world, 1);

      // Should have tried to place seeds but some failed
      expect(plant.seedsDropped.length).toBeLessThan(10);
    });
  });

  describe('Acceptance Criterion 6: Plant Health Decay', () => {
    it('should decrement health when hydration is low', () => {
      const entity = world.createEntity();
      const plant = new PlantComponent({
        speciesId: 'wheat',
        position: { x: 10, y: 20 },
        stage: 'vegetative'
      });
      entity.addComponent(PlantComponent, plant);

      plant.hydration = 10; // Very low
      const initialHealth = plant.health;

      system.update(world, 1);

      expect(plant.health).toBeLessThan(initialHealth);
    });

    it('should decrement health when nutrition is low', () => {
      const entity = world.createEntity();
      const plant = new PlantComponent({
        speciesId: 'wheat',
        position: { x: 10, y: 20 },
        stage: 'vegetative'
      });
      entity.addComponent(PlantComponent, plant);

      plant.nutrition = 10; // Very low
      const initialHealth = plant.health;

      system.update(world, 1);

      expect(plant.health).toBeLessThan(initialHealth);
    });

    it('should emit health warning event when health drops below threshold', () => {
      const entity = world.createEntity();
      const plant = new PlantComponent({
        speciesId: 'wheat',
        position: { x: 10, y: 20 },
        stage: 'vegetative'
      });
      entity.addComponent(PlantComponent, plant);

      plant.health = 100;
      plant.hydration = 5; // Critical

      const handler = vi.fn();
      eventBus.on('plant:healthChanged', handler);

      system.update(world, 1);

      expect(handler).toHaveBeenCalled();
      expect(handler.mock.calls[0][0].health).toBeLessThan(50);
    });

    it('should transition to dead stage when health reaches 0', () => {
      const entity = world.createEntity();
      const plant = new PlantComponent({
        speciesId: 'wheat',
        position: { x: 10, y: 20 },
        stage: 'vegetative'
      });
      entity.addComponent(PlantComponent, plant);

      plant.health = 1;
      plant.hydration = 0;
      plant.nutrition = 0;

      system.update(world, 1);

      expect(plant.health).toBe(0);
      expect(plant.stage).toBe('dead');
    });

    it('should emit plant:died event when plant dies', () => {
      const entity = world.createEntity();
      const plant = new PlantComponent({
        speciesId: 'wheat',
        position: { x: 10, y: 20 },
        stage: 'vegetative'
      });
      entity.addComponent(PlantComponent, plant);

      plant.health = 0;

      const handler = vi.fn();
      eventBus.on('plant:died', handler);

      system.update(world, 1);

      expect(handler).toHaveBeenCalledWith({
        entityId: entity.id,
        speciesId: 'wheat',
        position: { x: 10, y: 20 },
        age: expect.any(Number)
      });
    });
  });

  describe('Acceptance Criterion 8: Weather Integration', () => {
    it('should increase hydration when rain event occurs', () => {
      const entity = world.createEntity();
      const plant = new PlantComponent({
        speciesId: 'wheat',
        position: { x: 10, y: 20 },
        stage: 'vegetative'
      });
      entity.addComponent(PlantComponent, plant);

      plant.hydration = 50;

      eventBus.emit('weather:rain', { intensity: 'heavy' });

      system.update(world, 1);

      expect(plant.hydration).toBeGreaterThan(50);
    });

    it('should decrease hydration faster in hot weather', () => {
      const entity = world.createEntity();
      const plant = new PlantComponent({
        speciesId: 'wheat',
        position: { x: 10, y: 20 },
        stage: 'vegetative'
      });
      entity.addComponent(PlantComponent, plant);

      plant.hydration = 100;

      // Mock hot temperature
      vi.spyOn(system as any, 'getEnvironment').mockReturnValue({
        temperature: 35, // Very hot
        moisture: 20,
        nutrients: 100,
        season: 'summer',
        lightLevel: 100
      });

      system.update(world, 1);

      expect(plant.hydration).toBeLessThan(100);
    });

    it('should damage cold-sensitive plants when frost occurs', () => {
      const entity = world.createEntity();
      const plant = new PlantComponent({
        speciesId: 'tomato', // Cold-sensitive
        position: { x: 10, y: 20 },
        stage: 'vegetative',
        genetics: {
          growthRate: 1.0,
          yieldAmount: 1.0,
          diseaseResistance: 50,
          droughtTolerance: 50,
          coldTolerance: 20, // Low tolerance
          flavorProfile: 50,
          mutations: []
        }
      });
      entity.addComponent(PlantComponent, plant);

      const initialHealth = plant.health;

      eventBus.emit('weather:frost', { temperature: -2 });

      system.update(world, 1);

      expect(plant.health).toBeLessThan(initialHealth);
    });

    it('should NOT damage cold-tolerant plants when frost occurs', () => {
      const entity = world.createEntity();
      const plant = new PlantComponent({
        speciesId: 'wheat', // Cold-tolerant
        position: { x: 10, y: 20 },
        stage: 'vegetative',
        genetics: {
          growthRate: 1.0,
          yieldAmount: 1.0,
          diseaseResistance: 50,
          droughtTolerance: 50,
          coldTolerance: 90, // High tolerance
          flavorProfile: 50,
          mutations: []
        }
      });
      entity.addComponent(PlantComponent, plant);

      const initialHealth = plant.health;

      eventBus.emit('weather:frost', { temperature: -2 });

      system.update(world, 1);

      expect(plant.health).toBe(initialHealth);
    });
  });

  describe('Acceptance Criterion 9: Error Handling', () => {
    it('should throw error when speciesId is missing', () => {
      const entity = world.createEntity();
      const plant = {} as any; // Missing speciesId
      entity.addComponent(PlantComponent, plant);

      expect(() => {
        system.update(world, 1);
      }).toThrow('speciesId');
    });

    it('should throw error when species definition not found', () => {
      const entity = world.createEntity();
      const plant = new PlantComponent({
        speciesId: 'nonexistent_species',
        position: { x: 10, y: 20 }
      });
      entity.addComponent(PlantComponent, plant);

      expect(() => {
        system.update(world, 1);
      }).toThrow('PlantSpecies not found: nonexistent_species');
    });

    it('should throw error when required plant data is missing', () => {
      const entity = world.createEntity();
      const plant = new PlantComponent({
        speciesId: 'wheat',
        position: { x: 10, y: 20 }
      });
      entity.addComponent(PlantComponent, plant);

      // Corrupt the health field
      delete (plant as any).health;

      expect(() => {
        system.update(world, 1);
      }).toThrow('health');
    });

    it('should throw error when no transition defined for current stage', () => {
      const entity = world.createEntity();
      const plant = new PlantComponent({
        speciesId: 'wheat',
        position: { x: 10, y: 20 },
        stage: 'vegetative'
      });
      entity.addComponent(PlantComponent, plant);

      plant.stageProgress = 1.0;

      // Mock species with missing transition
      vi.spyOn(system as any, 'getSpecies').mockReturnValue({
        id: 'wheat',
        stageTransitions: [] // No transitions defined
      });

      expect(() => {
        system.update(world, 1);
      }).toThrow('No transition defined for stage: vegetative');
    });

    it('should NOT use fallback values for missing data', () => {
      const entity = world.createEntity();
      const plant = new PlantComponent({
        speciesId: 'wheat',
        position: { x: 10, y: 20 }
      });
      entity.addComponent(PlantComponent, plant);

      // Remove required field
      delete (plant as any).hydration;

      // Should throw, NOT use default value
      expect(() => {
        system.update(world, 1);
      }).toThrow();
    });
  });

  describe('Daily update cycle', () => {
    it('should increment plant age each day', () => {
      const entity = world.createEntity();
      const plant = new PlantComponent({
        speciesId: 'wheat',
        position: { x: 10, y: 20 }
      });
      entity.addComponent(PlantComponent, plant);

      const initialAge = plant.age;

      // Trigger day change
      eventBus.emit('time:dayStart', { day: 1 });
      system.update(world, 1);

      expect(plant.age).toBe(initialAge + 1);
    });

    it('should update hydration decay daily', () => {
      const entity = world.createEntity();
      const plant = new PlantComponent({
        speciesId: 'wheat',
        position: { x: 10, y: 20 },
        stage: 'vegetative'
      });
      entity.addComponent(PlantComponent, plant);

      plant.hydration = 100;

      eventBus.emit('time:dayStart', { day: 1 });
      system.update(world, 1);

      expect(plant.hydration).toBeLessThan(100);
    });

    it('should progress stage based on daily growth', () => {
      const entity = world.createEntity();
      const plant = new PlantComponent({
        speciesId: 'wheat',
        position: { x: 10, y: 20 },
        stage: 'vegetative'
      });
      entity.addComponent(PlantComponent, plant);

      const initialProgress = plant.stageProgress;

      eventBus.emit('time:dayStart', { day: 1 });
      system.update(world, 1);

      expect(plant.stageProgress).toBeGreaterThan(initialProgress);
    });
  });

  describe('System priority and registration', () => {
    it('should have correct priority for execution order', () => {
      expect(system.priority).toBe(20);
    });

    it('should be registered in World', () => {
      const world = new World();
      const system = new PlantSystem(eventBus);
      world.registerSystem(system);

      expect(world.systems).toContain(system);
    });
  });
});
