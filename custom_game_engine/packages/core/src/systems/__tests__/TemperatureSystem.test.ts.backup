import { describe, it, expect, beforeEach, vi } from 'vitest';
import { WorldImpl } from '../../ecs/World';
import type { World } from '../../ecs/World';
import { TemperatureSystem } from '../TemperatureSystem';
import { createTemperatureComponent } from '../../components/TemperatureComponent';
import { createPositionComponent } from '../../components/PositionComponent';
import type { NeedsComponent } from '../../components/NeedsComponent';
import type { BuildingComponent } from '../../components/BuildingComponent';
import type { WeatherComponent } from '../../components/WeatherComponent';
import { EventBusImpl } from '../../events/EventBus';
import type { EventBus } from '../../events/EventBus';
import { EntityImpl, createEntityId } from '../../ecs/Entity';

describe('TemperatureSystem', () => {
  let world: WorldImpl;
  let system: TemperatureSystem;
  let eventBus: EventBusImpl;

  beforeEach(() => {
    eventBus = new EventBusImpl();
    world = new WorldImpl(eventBus);
    system = new TemperatureSystem();
  });

  describe('Acceptance Criterion 1: Temperature Calculation', () => {
    it('should calculate world temperature for temperate biome in winter at night', () => {
      // Create world entity with weather
      const worldEntity = world.createEntity();
      worldEntity.addComponent(WeatherComponent, {
        type: 'clear',
        intensity: 0,
        tempModifier: 0,
        movementModifier: 1.0,
        visibilityModifier: 1.0
      });

      // Temperate biome, winter, nighttime
      const baseTemp = -5; // Winter base temp
      const timeOfDay = Math.PI * 1.5; // Midnight (coldest)
      const dailyVariation = 8; // ±8°C daily swing

      const expectedTemp = baseTemp + dailyVariation * Math.sin(timeOfDay);
      // Expected: -5 + 8 * sin(1.5π) = -5 + 8 * (-1) = -13°C

      system.update(world, 0.016);

      // This will be tested through integration - temperature should be ~-13°C
      expect(expectedTemp).toBeCloseTo(-13, 1);
    });

    it('should calculate world temperature with daily variation', () => {
      const baseTemp = 20;
      const dailyVariation = 10;

      // Noon (warmest)
      const noonTime = Math.PI * 0.5;
      const noonTemp = baseTemp + dailyVariation * Math.sin(noonTime);
      expect(noonTemp).toBeCloseTo(30, 1);

      // Midnight (coldest)
      const midnightTime = Math.PI * 1.5;
      const midnightTemp = baseTemp + dailyVariation * Math.sin(midnightTime);
      expect(midnightTemp).toBeCloseTo(10, 1);
    });
  });

  describe('Acceptance Criterion 2: Agent Temperature Comfort', () => {
    it('should set agent state to "cold" when ambient is between toleranceMin and comfortMin', () => {
      const agent = world.createEntity();
      agent.addComponent(TemperatureComponent, {
        currentTemp: 10,
        comfortMin: 18,
        comfortMax: 24,
        toleranceMin: 0,
        toleranceMax: 35,
        state: 'comfortable' // Will be recalculated
      });
      agent.addComponent(PositionComponent, { x: 0, y: 0 });

      system.update(world, 0.016);

      const temp = agent.getComponent(TemperatureComponent);
      if (!temp) throw new Error('TemperatureComponent not found');

      expect(temp.state).toBe('cold');
      expect(temp.currentTemp).toBeGreaterThanOrEqual(temp.toleranceMin);
      expect(temp.currentTemp).toBeLessThan(temp.comfortMin);
    });

    it('should set agent state to "comfortable" when ambient is within comfort range', () => {
      const agent = world.createEntity();
      agent.addComponent(TemperatureComponent, {
        currentTemp: 20,
        comfortMin: 18,
        comfortMax: 24,
        toleranceMin: 0,
        toleranceMax: 35,
        state: 'cold'
      });
      agent.addComponent(PositionComponent, { x: 0, y: 0 });

      system.update(world, 0.016);

      const temp = agent.getComponent(TemperatureComponent);
      if (!temp) throw new Error('TemperatureComponent not found');

      expect(temp.state).toBe('comfortable');
    });
  });

  describe('Acceptance Criterion 3: Dangerous Temperature Health Damage', () => {
    it('should apply 0.5 health damage per second when below toleranceMin', () => {
      const agent = world.createEntity();
      agent.addComponent(TemperatureComponent, {
        currentTemp: -10,
        comfortMin: 18,
        comfortMax: 24,
        toleranceMin: 0,
        toleranceMax: 35,
        state: 'dangerously_cold'
      });
      agent.addComponent(PositionComponent, { x: 0, y: 0 });
      agent.addComponent(NeedsComponent, {
        hunger: 100,
        energy: 100,
        health: 100
      });

      // Simulate 2 seconds at 60 FPS (120 frames * 0.016s)
      for (let i = 0; i < 120; i++) {
        system.update(world, 0.016);
      }

      const needs = agent.getComponent(NeedsComponent);
      if (!needs) throw new Error('NeedsComponent not found');

      // Should lose 1.0 health over 2 seconds (0.5/sec * 2sec)
      expect(needs.health).toBeCloseTo(99.0, 1);
    });

    it('should apply 0.5 health damage per second when above toleranceMax', () => {
      const agent = world.createEntity();
      agent.addComponent(TemperatureComponent, {
        currentTemp: 40,
        comfortMin: 18,
        comfortMax: 24,
        toleranceMin: 0,
        toleranceMax: 35,
        state: 'dangerously_hot'
      });
      agent.addComponent(PositionComponent, { x: 0, y: 0 });
      agent.addComponent(NeedsComponent, {
        hunger: 100,
        energy: 100,
        health: 100
      });

      // Simulate 2 seconds
      for (let i = 0; i < 120; i++) {
        system.update(world, 0.016);
      }

      const needs = agent.getComponent(NeedsComponent);
      if (!needs) throw new Error('NeedsComponent not found');

      expect(needs.health).toBeCloseTo(99.0, 1);
    });

    it('should not apply damage when temperature is within tolerance range', () => {
      const agent = world.createEntity();
      agent.addComponent(TemperatureComponent, {
        currentTemp: 10,
        comfortMin: 18,
        comfortMax: 24,
        toleranceMin: 0,
        toleranceMax: 35,
        state: 'cold'
      });
      agent.addComponent(PositionComponent, { x: 0, y: 0 });
      agent.addComponent(NeedsComponent, {
        hunger: 100,
        energy: 100,
        health: 100
      });

      system.update(world, 0.016);

      const needs = agent.getComponent(NeedsComponent);
      if (!needs) throw new Error('NeedsComponent not found');

      // Health should remain at 100
      expect(needs.health).toBe(100);
    });

    it('should emit temperature:danger event when entering dangerous range', () => {
      const handler = vi.fn();
      eventBus.on('temperature:danger', handler);

      const agent = world.createEntity();
      agent.addComponent(TemperatureComponent, {
        currentTemp: -10,
        comfortMin: 18,
        comfortMax: 24,
        toleranceMin: 0,
        toleranceMax: 35,
        state: 'dangerously_cold'
      });
      agent.addComponent(PositionComponent, { x: 0, y: 0 });

      system.update(world, 0.016);

      expect(handler).toHaveBeenCalledWith({
        entityId: agent.id,
        temperature: -10,
        state: 'dangerously_cold'
      });

      eventBus.off('temperature:danger', handler);
    });

    it('should emit temperature:comfortable event when returning to safe range', () => {
      const handler = vi.fn();
      eventBus.on('temperature:comfortable', handler);

      const agent = world.createEntity();
      agent.addComponent(TemperatureComponent, {
        currentTemp: 20,
        comfortMin: 18,
        comfortMax: 24,
        toleranceMin: 0,
        toleranceMax: 35,
        state: 'comfortable'
      });
      agent.addComponent(PositionComponent, { x: 0, y: 0 });

      system.update(world, 0.016);

      expect(handler).toHaveBeenCalledWith({
        entityId: agent.id,
        temperature: 20,
        state: 'comfortable'
      });

      eventBus.off('temperature:comfortable', handler);
    });

    it('should emit agent:health_critical when health drops below 20', () => {
      const handler = vi.fn();
      eventBus.on('agent:health_critical', handler);

      const agent = world.createEntity();
      agent.addComponent(TemperatureComponent, {
        currentTemp: -10,
        comfortMin: 18,
        comfortMax: 24,
        toleranceMin: 0,
        toleranceMax: 35,
        state: 'dangerously_cold'
      });
      agent.addComponent(PositionComponent, { x: 0, y: 0 });
      agent.addComponent(NeedsComponent, {
        hunger: 100,
        energy: 100,
        health: 21 // Just above threshold
      });

      // Simulate enough time to drop below 20
      for (let i = 0; i < 200; i++) {
        system.update(world, 0.016);
      }

      expect(handler).toHaveBeenCalled();

      eventBus.off('agent:health_critical', handler);
    });
  });

  describe('Acceptance Criterion 5: Heat Source Radiation', () => {
    it('should apply heat bonus when agent is 2 tiles from campfire with heatRadius 3', () => {
      // Create campfire
      const campfire = world.createEntity();
      campfire.addComponent(BuildingComponent, {
        buildingType: 'campfire',
        isConstructed: true,
        constructionProgress: 100,
        providesHeat: true,
        heatRadius: 3,
        heatAmount: 10,
        insulation: 0,
        baseTemperature: 0,
        weatherProtection: 0,
        interior: false,
        interiorRadius: 0
      });
      campfire.addComponent(PositionComponent, { x: 0, y: 0 });

      // Create agent 2 tiles away
      const agent = world.createEntity();
      agent.addComponent(TemperatureComponent, {
        currentTemp: 0,
        comfortMin: 18,
        comfortMax: 24,
        toleranceMin: 0,
        toleranceMax: 35,
        state: 'dangerously_cold'
      });
      agent.addComponent(PositionComponent, { x: 2, y: 0 });

      system.update(world, 0.016);

      const temp = agent.getComponent(TemperatureComponent);
      if (!temp) throw new Error('TemperatureComponent not found');

      // Heat effect = 10 * (1 - 2/3) = 10 * 0.333 = 3.33°C
      // Expected temp: 0 (ambient) + 3.33 = 3.33°C
      expect(temp.currentTemp).toBeCloseTo(3.33, 1);
    });

    it('should not apply heat beyond heatRadius', () => {
      const campfire = world.createEntity();
      campfire.addComponent(BuildingComponent, {
        buildingType: 'campfire',
        isConstructed: true,
        constructionProgress: 100,
        providesHeat: true,
        heatRadius: 3,
        heatAmount: 10,
        insulation: 0,
        baseTemperature: 0,
        weatherProtection: 0,
        interior: false,
        interiorRadius: 0
      });
      campfire.addComponent(PositionComponent, { x: 0, y: 0 });

      // Agent 4 tiles away (outside radius)
      const agent = world.createEntity();
      agent.addComponent(TemperatureComponent, {
        currentTemp: 0,
        comfortMin: 18,
        comfortMax: 24,
        toleranceMin: 0,
        toleranceMax: 35,
        state: 'dangerously_cold'
      });
      agent.addComponent(PositionComponent, { x: 4, y: 0 });

      system.update(world, 0.016);

      const temp = agent.getComponent(TemperatureComponent);
      if (!temp) throw new Error('TemperatureComponent not found');

      // No heat effect beyond radius
      expect(temp.currentTemp).toBe(0);
    });

    it('should handle multiple overlapping heat sources', () => {
      // Campfire 1
      const campfire1 = world.createEntity();
      campfire1.addComponent(BuildingComponent, {
        buildingType: 'campfire',
        isConstructed: true,
        constructionProgress: 100,
        providesHeat: true,
        heatRadius: 3,
        heatAmount: 10,
        insulation: 0,
        baseTemperature: 0,
        weatherProtection: 0,
        interior: false,
        interiorRadius: 0
      });
      campfire1.addComponent(PositionComponent, { x: 0, y: 0 });

      // Campfire 2
      const campfire2 = world.createEntity();
      campfire2.addComponent(BuildingComponent, {
        buildingType: 'campfire',
        isConstructed: true,
        constructionProgress: 100,
        providesHeat: true,
        heatRadius: 3,
        heatAmount: 10,
        insulation: 0,
        baseTemperature: 0,
        weatherProtection: 0,
        interior: false,
        interiorRadius: 0
      });
      campfire2.addComponent(PositionComponent, { x: 4, y: 0 });

      // Agent in middle (2 tiles from each)
      const agent = world.createEntity();
      agent.addComponent(TemperatureComponent, {
        currentTemp: 0,
        comfortMin: 18,
        comfortMax: 24,
        toleranceMin: 0,
        toleranceMax: 35,
        state: 'dangerously_cold'
      });
      agent.addComponent(PositionComponent, { x: 2, y: 0 });

      system.update(world, 0.016);

      const temp = agent.getComponent(TemperatureComponent);
      if (!temp) throw new Error('TemperatureComponent not found');

      // Each campfire contributes 3.33°C, total ~6.66°C
      expect(temp.currentTemp).toBeCloseTo(6.66, 1);
    });

    it('should handle agent exactly at heat source boundary (3 tiles)', () => {
      const campfire = world.createEntity();
      campfire.addComponent(BuildingComponent, {
        buildingType: 'campfire',
        isConstructed: true,
        constructionProgress: 100,
        providesHeat: true,
        heatRadius: 3,
        heatAmount: 10,
        insulation: 0,
        baseTemperature: 0,
        weatherProtection: 0,
        interior: false,
        interiorRadius: 0
      });
      campfire.addComponent(PositionComponent, { x: 0, y: 0 });

      const agent = world.createEntity();
      agent.addComponent(TemperatureComponent, {
        currentTemp: 0,
        comfortMin: 18,
        comfortMax: 24,
        toleranceMin: 0,
        toleranceMax: 35,
        state: 'dangerously_cold'
      });
      agent.addComponent(PositionComponent, { x: 3, y: 0 });

      system.update(world, 0.016);

      const temp = agent.getComponent(TemperatureComponent);
      if (!temp) throw new Error('TemperatureComponent not found');

      // At exactly 3 tiles: heat = 10 * (1 - 3/3) = 0
      expect(temp.currentTemp).toBe(0);
    });
  });

  describe('error handling', () => {
    it('should throw when TemperatureComponent is missing required fields', () => {
      const entity = world.createEntity();

      expect(() => {
        entity.addComponent(TemperatureComponent, {});
      }).toThrow();
    });

    it('should throw when NeedsComponent is missing health field', () => {
      const entity = world.createEntity();

      expect(() => {
        entity.addComponent(NeedsComponent, {
          hunger: 100,
          energy: 100
          // Missing health
        });
      }).toThrow();
    });
  });
});
