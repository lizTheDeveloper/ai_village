import { describe, it, expect, beforeEach, vi } from 'vitest';
import { WorldImpl } from '../ecs/World.js';
import { EventBusImpl } from '../events/EventBus.js';
import type { Entity } from '../ecs/Entity.js';

/**
 * Test Suite: Seed Germination System
 *
 * Covers:
 * - Criterion 5: Natural Seed Dispersal
 * - Criterion 9: Germination Conditions
 * - Criterion 11: Seed Quality Effects
 */

interface SeedGenetics {
  growthRate: number;
  yield: number;
  diseaseResistance: number;
  droughtTolerance: number;
  coldTolerance: number;
  flavor: number;
}

describe('SeedGerminationSystem', () => {
  let world: WorldImpl;
  let eventBus: EventBusImpl;
  let system: any;
  let seedEntity: Entity;
  let plantEntity: Entity;

  beforeEach(() => {
    eventBus = new EventBusImpl();
    world = new WorldImpl(eventBus);
    const SeedGerminationSystem = world.getSystemClass('SeedGerminationSystem');
    if (!SeedGerminationSystem) {
      throw new Error('SeedGerminationSystem not registered');
    }
    system = new SeedGerminationSystem();
  });

  describe('Criterion 5: Natural Seed Dispersal', () => {
    it('should drop 30% of seeds when plant enters seeding stage', () => {
      const PlantComponent = world.getComponentClass('PlantComponent');
      if (!PlantComponent) {
        throw new Error('PlantComponent not registered');
      }

      plantEntity = world.createEntity();
      plantEntity.addComponent('PlantComponent', {
        speciesId: 'wheat',
        stage: 'mature',
        seedsPerPlant: 100,
        remainingSeeds: 100,
        genetics: {
          growthRate: 0.5,
          yield: 0.5,
          diseaseResistance: 0.5,
          droughtTolerance: 0.5,
          coldTolerance: 0.5,
          flavor: 0.5
        }
      });

      plantEntity.addComponent('PositionComponent', { x: 10, y: 10 });

      // Trigger stage change to seeding
      const plant = plantEntity.getComponent('PlantComponent');
      plant.stage = 'seeding';

      system.update(world, 1);

      // Should drop ~30 seeds (30% of 100)
      const droppedSeeds = world.getEntitiesWithComponent('SeedComponent')
        .filter(e => !e.hasComponent('InventoryItem'));

      expect(droppedSeeds.length).toBeGreaterThanOrEqual(25);
      expect(droppedSeeds.length).toBeLessThanOrEqual(35);

      // Plant should have fewer remaining seeds
      expect(plant.remainingSeeds).toBeLessThan(100);
    });

    it('should calculate random drop positions within seed dispersal radius', () => {
      const PlantComponent = world.getComponentClass('PlantComponent');
      if (!PlantComponent) {
        throw new Error('PlantComponent not registered');
      }

      plantEntity = world.createEntity();
      plantEntity.addComponent('PlantComponent', {
        speciesId: 'oak',
        stage: 'seeding',
        seedsPerPlant: 50,
        remainingSeeds: 50,
        seedDispersalRadius: 5,
        genetics: {
          growthRate: 0.5,
          yield: 0.5,
          diseaseResistance: 0.5,
          droughtTolerance: 0.5,
          coldTolerance: 0.5,
          flavor: 0.5
        }
      });

      plantEntity.addComponent('PositionComponent', { x: 20, y: 20 });

      system.update(world, 1);

      const droppedSeeds = world.getEntitiesWithComponent('SeedComponent')
        .filter(e => e.hasComponent('PositionComponent') && !e.hasComponent('InventoryItem'));

      // All seeds should be within dispersal radius
      droppedSeeds.forEach(seed => {
        const pos = seed.getComponent('PositionComponent');
        const distance = Math.sqrt(
          Math.pow(pos.x - 20, 2) + Math.pow(pos.y - 20, 2)
        );
        expect(distance).toBeLessThanOrEqual(5);
      });
    });

    it('should place seeds on ground as entities', () => {
      const PlantComponent = world.getComponentClass('PlantComponent');
      if (!PlantComponent) {
        throw new Error('PlantComponent not registered');
      }

      plantEntity = world.createEntity();
      plantEntity.addComponent('PlantComponent', {
        speciesId: 'sunflower',
        stage: 'seeding',
        seedsPerPlant: 30,
        remainingSeeds: 30,
        genetics: {
          growthRate: 0.5,
          yield: 0.5,
          diseaseResistance: 0.5,
          droughtTolerance: 0.5,
          coldTolerance: 0.5,
          flavor: 0.5
        }
      });

      plantEntity.addComponent('PositionComponent', { x: 15, y: 15 });

      system.update(world, 1);

      const droppedSeeds = world.getEntitiesWithComponent('SeedComponent')
        .filter(e => !e.hasComponent('InventoryItem'));

      // Seeds should exist as entities
      expect(droppedSeeds.length).toBeGreaterThan(0);

      // Each seed should have required components
      droppedSeeds.forEach(seed => {
        expect(seed.hasComponent('SeedComponent')).toBe(true);
        expect(seed.hasComponent('PositionComponent')).toBe(true);
      });
    });

    it('should check germination conditions for each dropped seed', () => {
      const PlantComponent = world.getComponentClass('PlantComponent');
      if (!PlantComponent) {
        throw new Error('PlantComponent not registered');
      }

      plantEntity = world.createEntity();
      plantEntity.addComponent('PlantComponent', {
        speciesId: 'wildflower',
        stage: 'seeding',
        seedsPerPlant: 20,
        remainingSeeds: 20,
        genetics: {
          growthRate: 0.5,
          yield: 0.5,
          diseaseResistance: 0.5,
          droughtTolerance: 0.5,
          coldTolerance: 0.5,
          flavor: 0.5
        }
      });

      plantEntity.addComponent('PositionComponent', { x: 10, y: 10 });

      // Mock soil conditions
      const mockTile = {
        fertility: 60,
        moisture: 50,
        temperature: 20,
        occupied: false
      };

      vi.spyOn(world, 'getTileAt').mockReturnValue(mockTile);

      system.update(world, 1);

      // System should have checked germination for each seed
      expect(world.getTileAt).toHaveBeenCalled();
    });

    it('should schedule germination if conditions met', () => {
      const PlantComponent = world.getComponentClass('PlantComponent');
      if (!PlantComponent) {
        throw new Error('PlantComponent not registered');
      }

      plantEntity = world.createEntity();
      plantEntity.addComponent('PlantComponent', {
        speciesId: 'clover',
        stage: 'seeding',
        seedsPerPlant: 40,
        remainingSeeds: 40,
        genetics: {
          growthRate: 0.5,
          yield: 0.5,
          diseaseResistance: 0.5,
          droughtTolerance: 0.5,
          coldTolerance: 0.5,
          flavor: 0.5
        }
      });

      plantEntity.addComponent('PositionComponent', { x: 10, y: 10 });

      // Good germination conditions
      const mockTile = {
        fertility: 80,
        moisture: 70,
        temperature: 22,
        occupied: false
      };

      vi.spyOn(world, 'getTileAt').mockReturnValue(mockTile);

      system.update(world, 1);

      // Some seeds should have GerminationScheduledComponent
      const scheduledSeeds = world.getEntitiesWithComponent('GerminationScheduledComponent');
      expect(scheduledSeeds.length).toBeGreaterThan(0);
    });

    it('should create new plant entities from germinated seeds', () => {
      const SeedComponent = world.getComponentClass('SeedComponent');
      if (!SeedComponent) {
        throw new Error('SeedComponent not registered');
      }

      // Create seed ready to germinate
      seedEntity = world.createEntity();
      seedEntity.addComponent('SeedComponent', {
        speciesId: 'grass',
        genetics: {
          growthRate: 0.6,
          yield: 0.5,
          diseaseResistance: 0.5,
          droughtTolerance: 0.5,
          coldTolerance: 0.5,
          flavor: 0.5
        },
        generation: 1,
        parentPlantIds: ['parent-123'],
        viability: 0.95,
        vigor: 1.0,
        quality: 0.85,
        ageInDays: 2,
        dormant: false,
        sourceType: 'wild'
      });

      seedEntity.addComponent('PositionComponent', { x: 5, y: 5 });
      seedEntity.addComponent('GerminationScheduledComponent', { daysUntilGermination: 0 });

      const initialPlantCount = world.getEntitiesWithComponent('PlantComponent').length;

      system.update(world, 1);

      const finalPlantCount = world.getEntitiesWithComponent('PlantComponent').length;

      expect(finalPlantCount).toBeGreaterThan(initialPlantCount);
    });
  });

  describe('Criterion 9: Germination Conditions', () => {
    beforeEach(() => {
      seedEntity = world.createEntity();
      seedEntity.addComponent('SeedComponent', {
        speciesId: 'tomato',
        genetics: {
          growthRate: 0.5,
          yield: 0.5,
          diseaseResistance: 0.5,
          droughtTolerance: 0.5,
          coldTolerance: 0.5,
          flavor: 0.5
        },
        generation: 0,
        parentPlantIds: [],
        viability: 0.9,
        vigor: 1.0,
        quality: 0.85,
        ageInDays: 0,
        dormant: false,
        sourceType: 'wild'
      });

      seedEntity.addComponent('PositionComponent', { x: 10, y: 10 });
    });

    it('should verify dormancy is broken before germination', () => {
      const dormantSeed = world.createEntity();
      dormantSeed.addComponent('SeedComponent', {
        speciesId: 'apple',
        genetics: {
          growthRate: 0.5,
          yield: 0.5,
          diseaseResistance: 0.5,
          droughtTolerance: 0.5,
          coldTolerance: 0.5,
          flavor: 0.5
        },
        generation: 0,
        parentPlantIds: [],
        viability: 0.95,
        vigor: 1.0,
        quality: 0.9,
        ageInDays: 0,
        dormant: true,
        dormancyRequirements: {
          requiresColdStratification: true,
          coldDaysRequired: 90
        },
        sourceType: 'wild'
      });

      dormantSeed.addComponent('PositionComponent', { x: 10, y: 10 });

      const mockTile = {
        fertility: 80,
        moisture: 70,
        temperature: 22,
        occupied: false
      };

      vi.spyOn(world, 'getTileAt').mockReturnValue(mockTile);

      const canGerminate = system.checkGerminationConditions(dormantSeed);

      expect(canGerminate).toBe(false);
    });

    it('should require minimum soil fertility (>= 20)', () => {
      const lowFertilityTile = {
        fertility: 10,
        moisture: 70,
        temperature: 22,
        occupied: false
      };

      vi.spyOn(world, 'getTileAt').mockReturnValue(lowFertilityTile);

      const canGerminate = system.checkGerminationConditions(seedEntity);

      expect(canGerminate).toBe(false);
    });

    it('should require minimum soil moisture', () => {
      const mockSpecies = {
        minMoisture: 40
      };

      vi.spyOn(world, 'getSpeciesData').mockReturnValue(mockSpecies);

      const lowMoistureTile = {
        fertility: 80,
        moisture: 20,
        temperature: 22,
        occupied: false
      };

      vi.spyOn(world, 'getTileAt').mockReturnValue(lowMoistureTile);

      const canGerminate = system.checkGerminationConditions(seedEntity);

      expect(canGerminate).toBe(false);
    });

    it('should require tile to be unoccupied', () => {
      const occupiedTile = {
        fertility: 80,
        moisture: 70,
        temperature: 22,
        occupied: true
      };

      vi.spyOn(world, 'getTileAt').mockReturnValue(occupiedTile);

      const canGerminate = system.checkGerminationConditions(seedEntity);

      expect(canGerminate).toBe(false);
    });

    it('should require temperature within species range', () => {
      const mockSpecies = {
        minTemperature: 15,
        maxTemperature: 30
      };

      vi.spyOn(world, 'getSpeciesData').mockReturnValue(mockSpecies);

      const coldTile = {
        fertility: 80,
        moisture: 70,
        temperature: 5,
        occupied: false
      };

      vi.spyOn(world, 'getTileAt').mockReturnValue(coldTile);

      const canGerminate = system.checkGerminationConditions(seedEntity);

      expect(canGerminate).toBe(false);
    });

    it('should calculate germination chance based on viability, fertility, and moisture', () => {
      const mockTile = {
        fertility: 60,
        moisture: 50,
        temperature: 22,
        occupied: false
      };

      vi.spyOn(world, 'getTileAt').mockReturnValue(mockTile);

      const chance = system.calculateGerminationChance(seedEntity, mockTile);

      // Chance = viability × (fertility/100) × (moisture/100)
      // = 0.9 × 0.6 × 0.5 = 0.27
      expect(chance).toBeCloseTo(0.27, 2);
    });

    it('should have higher germination chance on good soil', () => {
      const goodTile = {
        fertility: 100,
        moisture: 100,
        temperature: 22,
        occupied: false
      };

      const poorTile = {
        fertility: 30,
        moisture: 30,
        temperature: 22,
        occupied: false
      };

      vi.spyOn(world, 'getTileAt').mockReturnValueOnce(goodTile);
      const goodChance = system.calculateGerminationChance(seedEntity, goodTile);

      vi.spyOn(world, 'getTileAt').mockReturnValueOnce(poorTile);
      const poorChance = system.calculateGerminationChance(seedEntity, poorTile);

      expect(goodChance).toBeGreaterThan(poorChance);
    });
  });

  describe('Criterion 11: Seed Quality Effects', () => {
    it('should transfer seed genetics to resulting plant', () => {
      const SeedComponent = world.getComponentClass('SeedComponent');
      const PlantComponent = world.getComponentClass('PlantComponent');

      if (!SeedComponent || !PlantComponent) {
        throw new Error('Required components not registered');
      }

      seedEntity = world.createEntity();
      const seedGenetics: SeedGenetics = {
        growthRate: 0.75,
        yield: 0.85,
        diseaseResistance: 0.65,
        droughtTolerance: 0.55,
        coldTolerance: 0.72,
        flavor: 0.68
      };

      seedEntity.addComponent('SeedComponent', {
        speciesId: 'carrot',
        genetics: seedGenetics,
        generation: 2,
        parentPlantIds: ['parent-1', 'parent-2'],
        viability: 0.95,
        vigor: 1.1,
        quality: 0.9,
        ageInDays: 0,
        dormant: false,
        sourceType: 'cultivated'
      });

      seedEntity.addComponent('PositionComponent', { x: 10, y: 10 });
      seedEntity.addComponent('GerminationScheduledComponent', { daysUntilGermination: 0 });

      const mockTile = {
        fertility: 80,
        moisture: 70,
        temperature: 20,
        occupied: false
      };

      vi.spyOn(world, 'getTileAt').mockReturnValue(mockTile);

      system.update(world, 1);

      const plants = world.getEntitiesWithComponent('PlantComponent');
      const newPlant = plants[plants.length - 1];

      expect(newPlant).toBeDefined();
      const plantGenetics = newPlant.getComponent('PlantComponent').genetics;

      expect(plantGenetics.growthRate).toBeCloseTo(0.75, 2);
      expect(plantGenetics.yield).toBeCloseTo(0.85, 2);
      expect(plantGenetics.diseaseResistance).toBeCloseTo(0.65, 2);
    });

    it('should affect plant growth rate by seed vigor', () => {
      const SeedComponent = world.getComponentClass('SeedComponent');
      const PlantComponent = world.getComponentClass('PlantComponent');

      if (!SeedComponent || !PlantComponent) {
        throw new Error('Required components not registered');
      }

      seedEntity = world.createEntity();

      seedEntity.addComponent('SeedComponent', {
        speciesId: 'wheat',
        genetics: {
          growthRate: 0.5,
          yield: 0.5,
          diseaseResistance: 0.5,
          droughtTolerance: 0.5,
          coldTolerance: 0.5,
          flavor: 0.5
        },
        generation: 1,
        parentPlantIds: ['parent-123'],
        viability: 0.95,
        vigor: 1.3, // High vigor
        quality: 0.9,
        ageInDays: 0,
        dormant: false,
        sourceType: 'cultivated'
      });

      seedEntity.addComponent('PositionComponent', { x: 10, y: 10 });
      seedEntity.addComponent('GerminationScheduledComponent', { daysUntilGermination: 0 });

      const mockTile = {
        fertility: 80,
        moisture: 70,
        temperature: 20,
        occupied: false
      };

      vi.spyOn(world, 'getTileAt').mockReturnValue(mockTile);

      system.update(world, 1);

      const plants = world.getEntitiesWithComponent('PlantComponent');
      const newPlant = plants[plants.length - 1];

      const plant = newPlant.getComponent('PlantComponent');

      // Growth rate should be base × vigor
      const expectedGrowthRate = 0.5 * 1.3;
      expect(plant.effectiveGrowthRate).toBeCloseTo(expectedGrowthRate, 2);
    });

    it('should affect max yield by seed quality', () => {
      const SeedComponent = world.getComponentClass('SeedComponent');
      const PlantComponent = world.getComponentClass('PlantComponent');

      if (!SeedComponent || !PlantComponent) {
        throw new Error('Required components not registered');
      }

      const highQualitySeed = world.createEntity();
      highQualitySeed.addComponent('SeedComponent', {
        speciesId: 'potato',
        genetics: {
          growthRate: 0.5,
          yield: 0.8,
          diseaseResistance: 0.5,
          droughtTolerance: 0.5,
          coldTolerance: 0.5,
          flavor: 0.5
        },
        generation: 1,
        parentPlantIds: ['parent-123'],
        viability: 0.95,
        vigor: 1.0,
        quality: 0.95, // High quality
        ageInDays: 0,
        dormant: false,
        sourceType: 'cultivated'
      });

      highQualitySeed.addComponent('PositionComponent', { x: 10, y: 10 });
      highQualitySeed.addComponent('GerminationScheduledComponent', { daysUntilGermination: 0 });

      const lowQualitySeed = world.createEntity();
      lowQualitySeed.addComponent('SeedComponent', {
        speciesId: 'potato',
        genetics: {
          growthRate: 0.5,
          yield: 0.8,
          diseaseResistance: 0.5,
          droughtTolerance: 0.5,
          coldTolerance: 0.5,
          flavor: 0.5
        },
        generation: 1,
        parentPlantIds: ['parent-456'],
        viability: 0.6,
        vigor: 0.8,
        quality: 0.4, // Low quality
        ageInDays: 100,
        dormant: false,
        sourceType: 'wild'
      });

      lowQualitySeed.addComponent('PositionComponent', { x: 15, y: 15 });
      lowQualitySeed.addComponent('GerminationScheduledComponent', { daysUntilGermination: 0 });

      const mockTile = {
        fertility: 80,
        moisture: 70,
        temperature: 20,
        occupied: false
      };

      vi.spyOn(world, 'getTileAt').mockReturnValue(mockTile);

      system.update(world, 1);

      const plants = world.getEntitiesWithComponent('PlantComponent');

      // Find the two new plants
      const highQualityPlant = plants.find(p => {
        const pos = p.getComponent('PositionComponent');
        return pos.x === 10 && pos.y === 10;
      });

      const lowQualityPlant = plants.find(p => {
        const pos = p.getComponent('PositionComponent');
        return pos.x === 15 && pos.y === 15;
      });

      expect(highQualityPlant).toBeDefined();
      expect(lowQualityPlant).toBeDefined();

      const highYield = highQualityPlant!.getComponent('PlantComponent').maxYield;
      const lowYield = lowQualityPlant!.getComponent('PlantComponent').maxYield;

      expect(highYield).toBeGreaterThan(lowYield);
    });

    it('should pass genetics to offspring seeds', () => {
      // This is tested in integration - when plant produces seeds, they inherit genetics
      // Placeholder to verify this behavior is tested
      expect(true).toBe(true);
    });
  });

  describe('Error Handling (per CLAUDE.md)', () => {
    it('should throw when trying to germinate seed without position', () => {
      seedEntity = world.createEntity();
      seedEntity.addComponent('SeedComponent', {
        speciesId: 'wheat',
        genetics: {
          growthRate: 0.5,
          yield: 0.5,
          diseaseResistance: 0.5,
          droughtTolerance: 0.5,
          coldTolerance: 0.5,
          flavor: 0.5
        },
        generation: 0,
        parentPlantIds: [],
        viability: 0.9,
        vigor: 1.0,
        quality: 0.85,
        ageInDays: 0,
        dormant: false,
        sourceType: 'wild'
      });

      // No PositionComponent added

      expect(() => {
        system.germinateSeed(seedEntity);
      }).toThrow(/position/i);
    });

    it('should throw when germination conditions check fails to find tile data', () => {
      seedEntity = world.createEntity();
      seedEntity.addComponent('SeedComponent', {
        speciesId: 'wheat',
        genetics: {
          growthRate: 0.5,
          yield: 0.5,
          diseaseResistance: 0.5,
          droughtTolerance: 0.5,
          coldTolerance: 0.5,
          flavor: 0.5
        },
        generation: 0,
        parentPlantIds: [],
        viability: 0.9,
        vigor: 1.0,
        quality: 0.85,
        ageInDays: 0,
        dormant: false,
        sourceType: 'wild'
      });

      seedEntity.addComponent('PositionComponent', { x: 999, y: 999 });

      // Mock getTileAt to return null (invalid tile)
      vi.spyOn(world, 'getTileAt').mockReturnValue(null);

      expect(() => {
        system.checkGerminationConditions(seedEntity);
      }).toThrow(/tile/i);
    });
  });
});
