# Bug Report - December 22, 2025

## BUG-001: Agent Selection Causes Page Reload

**Severity:** CRITICAL
**Status:** OPEN
**Discovered:** 2025-12-22
**Discovered By:** Playtest Agent, confirmed by Implementation Agent
**Affects:** Phase 8 Demo (http://localhost:3001)

### Description

Clicking on agent entities in the game canvas causes the entire page to reload/navigate, preventing any UI panels (AgentInfoPanel, etc.) from being displayed.

### Steps to Reproduce

1. Start the development server: `cd custom_game_engine/demo && npx vite --port 3001`
2. Open http://localhost:3001 in browser
3. Wait for game to load (agents appear as colored circles)
4. Click on any agent entity
5. **Expected:** AgentInfoPanel appears in top-right corner showing agent information
6. **Actual:** Page reloads entirely, resetting game state

### Evidence

**Playwright MCP Testing:**
```
Error: page.title: Execution context was destroyed, most likely because of a navigation
```

**Console Logs:**
- Ollama connection errors appear
- Followed immediately by page reinitialization messages:
  - "AI Village - Phase 8 Demo (Weather & Temperature)"
  - "Generating terrain..."
  - All initialization logs repeat

### Impact

**Blocks Testing of:**
- Agent Inventory Display feature (work-order: agent-inventory-display)
- AgentInfoPanel functionality in general
- Any feature requiring agent selection

**Does NOT Block:**
- Feature implementation (code is correct)
- Unit testing (all tests pass)
- Build process (builds successfully)

### Technical Analysis

#### Code Review

The click handling in `demo/src/main.ts` lines 182-199 appears correct:

```typescript
if (button === 0) {
  const entity = renderer.findEntityAtScreenPosition(screenX, screenY, gameLoop.world);
  if (entity) {
    const hasAgent = entity.components.has('agent');
    if (hasAgent) {
      console.log(`[Main] Selected agent: ${entity.id}`);
      agentInfoPanel.setSelectedEntity(entity);
      return true;
    }
```

#### Possible Causes

1. **Uncaught Exception:** An error in the click handler or subsequent code causes a crash that triggers page reload
2. **Ollama Connection Failure:** Ollama errors might trigger error handling that reloads the page
3. **Event Propagation:** Click event bubbles to an element that navigates
4. **Vite HMR Issue:** Hot Module Replacement incorrectly triggering on click (unlikely)

### Investigation Needed

1. **Add try-catch blocks** around click handling to catch any exceptions
2. **Check error boundaries** - see if there's global error handling that reloads on exception
3. **Inspect Ollama error handling** - connection failures shouldn't cause reload
4. **Debug click event flow** - ensure event.preventDefault() is called where needed
5. **Check for navigation triggers** - search for window.location, location.href, etc.

### Workaround

None available. Agent selection is completely broken.

### Related Files

- `custom_game_engine/demo/src/main.ts` - Click handling setup
- `custom_game_engine/packages/renderer/src/InputHandler.ts` - Input event handling
- `custom_game_engine/packages/renderer/src/Renderer.ts` - findEntityAtScreenPosition
- `custom_game_engine/packages/renderer/src/AgentInfoPanel.ts` - Panel that should display

### Priority

**HIGH** - This blocks playtesting of multiple features and makes the demo non-interactive.

### Suggested Fix Priority

Fix this bug **before** implementing new features that depend on agent selection.
