# Bug Report: End-to-End Testing - December 21, 2025

**Test Environment:** Phase 7 Demo (Building & Shelter)  
**Test Method:** Browser-based end-to-end testing using Playwright  
**Test Duration:** ~5 minutes of gameplay observation  
**Ticks Observed:** 0 ‚Üí 2531 (at 20 TPS)

## Executive Summary

End-to-end testing revealed **4 bugs**, including **2 critical silent failures** where systems appear to function but produce no actual results. The most severe is a complete failure of the building system despite agents actively attempting to build.

---

## üö® CRITICAL BUG #1: Building System Silent Failure

**Severity:** CRITICAL (P0 - Blocker)  
**Type:** Silent Failure  
**Systems Affected:** BuildingSystem, ActionQueue, Phase 7 Core Feature

### Description

The building system completely fails to create any building entities despite agents continuously deciding to build and appearing to execute build actions. This is a silent failure - the system logs success but produces no output.

### Evidence

**What appears to work:**
- ‚úÖ LLM generates build decisions: `[OllamaProvider] Structured response: {action: build, thinking: "Okay, let's s..."`
- ‚úÖ AI system parses decisions: `[AISystem] Parsed structured LLM decision: {entityId: ..., action: build}`
- ‚úÖ Agents stop moving (84 moving ‚Üí 5 moving), indicating they're attempting to build
- ‚úÖ No errors or warnings in console

**What's actually broken:**
- ‚ùå **Zero buildings created** in world state
- ‚ùå Entity count: 269 total = 86 agents + 183 resources + **0 buildings**
- ‚ùå No entities with `building` component exist
- ‚ùå ActionQueue shows 0 pending actions when queried
- ‚ùå Observed over 2500+ ticks with continuous build attempts

### Component Analysis

```javascript
// World state inspection results:
{
  "totalEntities": 269,
  "agents": 86,
  "buildings": 0,  // ‚Üê Should have buildings by now
  "sampleBuildings": []
}

// Entity type breakdown:
{
  "agent,conversation,identity,memory,movement,needs,personality,physics,position,relationship,renderable,tags,vision": 86,
  "physics,position,renderable,resource,tags": 183,
  // No building entity types found
}
```

### Expected Behavior

1. Agent decides to build (action: "build")
2. Build action queued to ActionQueue
3. BuildingSystem validates action
4. Building entity created with:
   - `building` component (type, owner, durability, shelter_value)
   - `physics` component
   - `position` component (at agent location)
   - `renderable` component
5. Building visible in world
6. Agent's shelter needs affected

### Actual Behavior

1. Agent decides to build ‚úì
2. Build action appears to be processed ‚úì
3. Agent stops moving ‚úì
4. **No building entity created** ‚úó
5. **No shelter value changes** ‚úó
6. Agent continues to worry about lack of shelter ‚úó

### Reproduction Steps

1. Start Phase 7 demo: `cd custom_game_engine/demo && npm run dev`
2. Open http://localhost:3000 in browser
3. Wait for agents to spawn
4. Observe console logs showing build actions
5. Check browser console: `window.gameLoop.world._entities` 
6. Count building components: Always 0

### Impact

- **Phase 7 completely non-functional** - titled "Building & Shelter" but building doesn't work
- **Silent failure** - no error messages, appears to work superficially
- **Agents stuck in loop** - continuously trying to build with no success
- **Simulation invalid** - agents never satisfy shelter needs

### Suspected Root Causes

1. **ActionQueue not receiving build actions** - Actions logged but never queued
2. **BuildingSystem not registered** - System exists but not in GameLoop
3. **Action validation failing silently** - Actions rejected without error logging
4. **Entity creation failing** - Building entities created but immediately destroyed
5. **Component missing** - Building component not properly defined/registered

### Recommended Investigation

- [ ] Verify BuildingSystem is registered in GameLoop.systems
- [ ] Add debug logging to ActionQueue.enqueue() for build actions
- [ ] Verify build action handler exists and is registered
- [ ] Check building component schema is registered in ComponentRegistry
- [ ] Add error logging for failed action validation
- [ ] Test building creation manually in console

### Related Specs

- `openspec/specs/game-engine/spec.md` - Action system
- Phase 7 implementation (Building & Shelter system)

---

## üö® CRITICAL BUG #2: Agents Hearing Their Own Speech

**Severity:** CRITICAL (P1)  
**Type:** Logic Error / Echo Chamber  
**Systems Affected:** CommunicationSystem, VisionSystem (hearing)

### Description

Agents hear their own speech, creating an echo chamber effect where agents are influenced by their own repeated messages. The effect compounds over time, with agents hearing themselves multiple times per tick.

### Evidence

**Console logs showing self-hearing:**

```
[AISystem] Sparrow heard 1 nearby speech(es): Sparrow: "I'm worried about being exposed without..."
[AISystem] Hazel heard 1 nearby speech(es): Hazel: "I'm worried about my shelter being so expo..."
[AISystem] Hazel heard 4 nearby speech(es): Hazel: "Hazel is worried about the urgent need for..."
[AISystem] Hazel heard 4 nearby speech(es): Hazel: "I'm worried about my shelter being so expo..."
[AISystem] Juniper heard 5 nearby speech(es): Juniper: "I'm worried about being exposed without..."
```

**Progression pattern observed:**
- Initially: 1 self-message per agent
- After 500 ticks: 2-4 self-messages per agent  
- After 1500 ticks: 4-5 self-messages per agent
- Pattern: Escalating echo chamber effect

### Expected Behavior

1. Agent speaks: `agent.speak("I'm worried...")`
2. Nearby agents within hearing range receive message
3. **Speaker does NOT hear their own message**
4. Message added to listeners' conversation history only

### Actual Behavior

1. Agent speaks: `agent.speak("I'm worried...")`
2. Nearby agents receive message ‚úì
3. **Speaker ALSO hears their own message** ‚úó
4. Speaker's own message influences their next decision ‚úó
5. **Message duplicates multiple times** ‚úó

### Impact

- **Simulation validity compromised** - Agents influenced by artificial feedback
- **Conversation logs polluted** - Each agent has duplicate self-references
- **Memory system corrupted** - Agents store memories of "hearing" themselves
- **Decision-making biased** - LLM receives context showing agent heard themselves
- **Escalating bug** - Gets worse over time as messages duplicate

### Reproduction Steps

1. Start demo and observe console logs
2. Search for pattern: `[AISystem] {Name} heard * nearby speech(es): {SameName}:`
3. Observe escalation: count increases from 1 ‚Üí 4 ‚Üí 5+ over time

### Root Cause Analysis

**Likely location:** `CommunicationSystem` or hearing detection in `VisionSystem`

**Hypothesis 1:** Hearing range query includes speaker
```typescript
// WRONG: Includes speaker in query
const nearbyAgents = world.query()
  .hasComponent('position')
  .hasComponent('agent')
  .withinRange(speaker.position, HEARING_RANGE)
  .execute();
// nearbyAgents includes the speaker!
```

**Hypothesis 2:** Speaker not filtered from listeners
```typescript
// MISSING: Filter to exclude speaker
nearbyAgents.forEach(listener => {
  // Should check: if (listener.id !== speaker.id)
  listener.hear(message);
});
```

**Hypothesis 3:** Message echoing in conversation component
- Conversation component stores messages
- When querying conversation history, speaker's own messages returned
- These get fed back as "heard" messages

### Recommended Fix

```typescript
// In CommunicationSystem or hearing detection:
const nearbyAgents = world.query()
  .hasComponent('position')
  .hasComponent('agent')
  .withinRange(speaker.position, HEARING_RANGE)
  .execute()
  .filter(agent => agent.id !== speaker.id);  // ‚Üê Add this line
```

### Validation

After fix, console should show:
```
[AISystem] Cedar heard 1 nearby speech(es): Dove: "I'm worried..."
[AISystem] Hazel heard 1 nearby speech(es): Rowan: "I'm worried..."
// Never: [AISystem] Hazel heard ... Hazel: ...
```

### Related Specs

- `openspec/specs/agent-system/conversation-system.md`
- Communication range and hearing mechanics

---

## üü° HIGH BUG #3: Zoom Controls Non-Functional

**Severity:** HIGH (P2)  
**Type:** Feature Not Working  
**Systems Affected:** InputHandler, Camera

### Description

Keyboard zoom controls (`+` and `-` keys) listed in UI controls panel do not function. Camera zoom level remains fixed at 1.00 despite multiple key presses.

### Evidence

**Test performed:**
- Pressed `+` key twice
- Observed debug overlay: `zoom: 1.00` (unchanged)
- Visual zoom level did not change
- No console errors or warnings

**Controls panel advertises:**
```
+ / - - Zoom
```

### Expected Behavior

1. User presses `+` key
2. Camera zoom increases (e.g., 1.00 ‚Üí 1.10 ‚Üí 1.20)
3. Debug overlay updates: `zoom: 1.20`
4. Visual representation zooms in (tiles appear larger)

### Actual Behavior

1. User presses `+` key
2. No change to zoom level
3. Debug overlay remains: `zoom: 1.00`
4. No visual change
5. No error messages

### Comparison: Working vs Broken Controls

**Working:**
- ‚úÖ WASD panning (camera position changes)
- ‚úÖ Arrow key panning  
- ‚úÖ Mouse drag panning

**Broken:**
- ‚ùå `+` key zoom in
- ‚ùå `-` key zoom out
- ‚ö†Ô∏è  Mouse wheel zoom (not tested)

### Suspected Root Causes

1. **Key event not bound** - InputHandler doesn't listen for `+`/`-` keys
2. **Key code mismatch** - Listening for wrong key codes (NumPad vs regular +/-)
3. **Zoom function not implemented** - Camera has zoom property but no zoom() method
4. **Event handler not called** - Handler exists but not connected to Camera

### Recommended Investigation

```typescript
// Check InputHandler.ts:
// Are these handlers present?
onKeyDown(event: KeyboardEvent) {
  switch(event.key) {
    case '+':
    case '=':  // Also handle = key (+ without shift)
      this.camera.zoom(1.1); // zoom in
      break;
    case '-':
      this.camera.zoom(0.9); // zoom out
      break;
  }
}
```

### Impact

- **User expectation violated** - Advertised feature doesn't work
- **Zoom functionality unavailable** - Users can't zoom in/out with keyboard
- **Poor UX** - Controls panel misleading

### Related Specs

- `openspec/specs/rendering-system/spec.md` - Camera controls
- `packages/renderer/src/InputHandler.ts`
- `packages/renderer/src/Camera.ts`

---

## üü¢ LOW BUG #4: Missing Favicon (404 Error)

**Severity:** LOW (P3)  
**Type:** Resource Not Found  
**Systems Affected:** Demo App

### Description

Browser requests `/favicon.ico` which returns 404 Not Found error.

### Evidence

```
[ERROR] Failed to load resource: the server responded with a status of 404 (Not Found) 
@ http://localhost:3000/favicon.ico:0
```

### Impact

- **Purely cosmetic** - Does not affect functionality
- **Console noise** - Adds error to otherwise clean console
- **Professional appearance** - Missing favicon looks unpolished

### Recommended Fix

**Option 1:** Add favicon
```bash
# In custom_game_engine/demo/
# Add public/favicon.ico file
```

**Option 2:** Remove reference
```html
<!-- In demo/index.html -->
<!-- Remove or update favicon link -->
```

---

## Test Methodology

### Tools Used
- Playwright MCP browser automation
- Chrome browser
- JavaScript console inspection
- Screenshot capture for visual verification

### Test Coverage

**Tested:**
- ‚úÖ Game loop execution (20 TPS verified)
- ‚úÖ Agent AI decisions (LLM integration)
- ‚úÖ Movement system (agents moving)
- ‚úÖ Camera panning (WASD, arrows)
- ‚úÖ Camera zoom attempt (keyboard)
- ‚úÖ World rendering (terrain, entities)
- ‚úÖ Communication system (agent speech)
- ‚úÖ Entity inspection (component analysis)

**Not Tested:**
- ‚ö†Ô∏è Mouse wheel zoom
- ‚ö†Ô∏è Mouse drag panning (mentioned but not verified)
- ‚ö†Ô∏è Needs system degradation over time
- ‚ö†Ô∏è Save/load functionality
- ‚ö†Ô∏è Day/night cycle progression
- ‚ö†Ô∏è Resource gathering
- ‚ö†Ô∏è Agent death/lifecycle

### World State at Test End

```
Tick: 2531 (126 seconds elapsed)
Game Time: Day 1, Spring, Year 1
Entities: 269 total
  - Agents: 86
  - Resources: 183 (trees, rocks)
  - Buildings: 0
Agents Moving: 5-7 (most stopped to attempt building)
Camera: (0.0, 0.0) zoom: 1.00
Performance: 1.3-1.6ms avg tick time
```

---

## Recommendations

### Immediate Actions (This Sprint)

- [ ] **BUG #1:** Investigate and fix building system (BLOCKER)
  - Priority: P0 - Phase 7 cannot ship without this
  - Estimated effort: 4-8 hours
  - Assign to: System implementer
  
- [ ] **BUG #2:** Fix agent self-hearing (CRITICAL)
  - Priority: P1 - Corrupts simulation validity
  - Estimated effort: 1-2 hours  
  - Likely one-line fix
  
- [ ] **BUG #3:** Implement zoom controls (HIGH)
  - Priority: P2 - Advertised feature
  - Estimated effort: 1-2 hours
  - Low complexity

### Next Sprint

- [ ] **BUG #4:** Add favicon or remove reference (LOW)
  - Priority: P3 - Cosmetic only
  - Estimated effort: 15 minutes

### Process Improvements

- [ ] Add automated E2E tests to catch silent failures
- [ ] Add error logging for action validation failures  
- [ ] Add assertions that building entities are created after build actions
- [ ] Add console warnings when advertised features are non-functional
- [ ] Implement smoke tests that verify core feature functionality

---

## Success Criteria for Bug Fixes

### BUG #1 Fixed When:
- [ ] Console: `Building entity created at (x, y)` logs appear
- [ ] World state: Buildings count > 0 after agent build attempts
- [ ] Visual: Buildings visible on map (different color/shape from agents)
- [ ] Agent needs: Shelter value increases when near buildings
- [ ] Multiple builds: Can create 10+ buildings without issues

### BUG #2 Fixed When:
- [ ] Console logs never show: `[AgentName] heard ... [SameAgentName]:`
- [ ] Agents only hear other agents' speech
- [ ] No escalation of message count over time
- [ ] Conversation logs contain only other agents' messages

### BUG #3 Fixed When:
- [ ] Pressing `+` key increases zoom (1.0 ‚Üí 1.1 ‚Üí 1.2...)
- [ ] Pressing `-` key decreases zoom (1.2 ‚Üí 1.1 ‚Üí 1.0...)
- [ ] Debug overlay updates: `zoom: [correct value]`
- [ ] Visual zoom change visible (tiles larger/smaller)
- [ ] Mouse wheel zoom also works (bonus)

### BUG #4 Fixed When:
- [ ] No 404 errors in browser console
- [ ] Favicon displays in browser tab (if added)
- [ ] Or favicon reference removed from HTML (if removed)

---

## Appendix: Test Screenshots

Test screenshots saved to `.playwright-mcp/`:
- `game-initial-load.png` - Initial state (tick 71)
- `game-after-3-seconds.png` - After 3s (tick 364)
- `game-after-pan-right.png` - After camera pan (tick 696)
- `game-panned-around.png` - After more exploration (tick 1648)
- `game-final-state.png` - Final state (tick 150, different session)

---

**Report Generated:** December 21, 2025  
**Tested By:** AI Assistant (Playwright automation)  
**Game Version:** Phase 7 Demo (Building & Shelter)  
**Test Session Duration:** ~5 minutes  
**Total Ticks Observed:** 2531 ticks @ 20 TPS

